<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0049)https://wiki.debian.org/EmDebian/CrossDebootstrap -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="https://wiki.debian.org/htdocs/favicon.ico">
<script type="text/javascript" src="./EmDebian_CrossDebootstrap - Debian Wiki_files/bugstatus.js.download"></script>

<meta name="robots" content="index,nofollow">

<title>EmDebian/CrossDebootstrap - Debian Wiki</title>
<script type="text/javascript" src="./EmDebian_CrossDebootstrap - Debian Wiki_files/common.js.download"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="./EmDebian_CrossDebootstrap - Debian Wiki_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="./EmDebian_CrossDebootstrap - Debian Wiki_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="./EmDebian_CrossDebootstrap - Debian Wiki_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="./EmDebian_CrossDebootstrap - Debian Wiki_files/projection.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="./EmDebian_CrossDebootstrap - Debian Wiki_files/debian-wiki-1.0.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->


<link rel="alternate" title="Debian Wiki: EmDebian/CrossDebootstrap" href="https://wiki.debian.org/EmDebian/CrossDebootstrap?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=EmDebian%2FCrossDebootstrap&amp;ddiffs=1" type="application/rss+xml">


<link rel="Start" href="https://wiki.debian.org/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=raw">
<link rel="Alternate" media="print" title="Print View" href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=print">
<link rel="Up" href="https://wiki.debian.org/EmDebian">
<link rel="Search" href="https://wiki.debian.org/FindPage">
<link rel="Index" href="https://wiki.debian.org/TitleIndex">
<link rel="Glossary" href="https://wiki.debian.org/WordIndex">
<link rel="Help" href="https://wiki.debian.org/HelpOnFormatting">
</head>

<body lang="en" dir="ltr">
<div id="logo"><a href="https://www.debian.org/" title="Debian Homepage"><img src="./EmDebian_CrossDebootstrap - Debian Wiki_files/openlogo-50.png" alt="Debian" width="50" height="61"></a></div>
<div id="header">
<div id="wikisection">
<p class="section"><a href="https://wiki.debian.org/FrontPage" title="Debian Wiki Homepage">Wiki</a></p>
<div id="username"><a href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=login" id="login" rel="nofollow">Login</a></div>
</div>
<div id="navbar">

<ul id="navibar">
<li class="wikilink"><a href="https://wiki.debian.org/FrontPage">FrontPage</a></li><li class="wikilink"><a href="https://wiki.debian.org/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="https://wiki.debian.org/FindPage">FindPage</a></li><li class="wikilink"><a href="https://wiki.debian.org/HelpContents">HelpContents</a></li><li class="current"><a href="https://wiki.debian.org/EmDebian/CrossDebootstrap">EmDebian/CrossDebootstrap</a></li>
</ul>

</div>

<form id="searchform" method="get" action="https://wiki.debian.org/EmDebian/CrossDebootstrap">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput" style="display: none;">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20" onfocus="searchFocus(this)" onblur="searchBlur(this)" onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search" class="disabled">
<input id="titlesearch" name="titlesearch" type="submit" value="Titles" alt="Search Titles" disabled="">
<input id="fullsearch" name="fullsearch" type="submit" value="Text" alt="Search Full Text" disabled="">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="https://www.debian.org/" title="Debian Homepage"><img src="./EmDebian_CrossDebootstrap - Debian Wiki_files/openlogo-50.png" alt="Debian" width="50" height="61"></a></div>

<div id="breadcrumbs"><a href="https://wiki.debian.org/FrontPage" title="Debian Wiki Homepage">Wiki</a><span class="sep">/</span>

</div>

<ul class="editbar"><li><a href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=login" id="login-1" rel="nofollow">Login</a></li><li class="toggleCommentsButton" style="display:none;"><a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#" class="nbcomment" onclick="toggleComments();return false;">Comments</a></li><li><a class="nbinfo" href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=info" rel="nofollow">Info</a></li><li><a class="nbattachments" href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="https://wiki.debian.org/EmDebian/CrossDebootstrap">
<div>
    
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="show">More Actions:</option><option value="raw">Raw Text</option>
<option value="print">Print View</option>
<option value="RenderAsDocbook">Render as Docbook</option>
<option value="refresh">Delete Cache</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="SpellCheck">Check Spelling</option>
<option value="LikePages">Like Pages</option>
<option value="LocalSiteMap">Local Site Map</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="RenamePage" disabled="" class="disabled">Rename Page</option>
<option value="DeletePage" disabled="" class="disabled">Delete Page</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="show" disabled="" class="disabled">Subscribe User</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="show" disabled="" class="disabled">Remove Spam</option>
<option value="show" disabled="" class="disabled">Revert to this revision</option>
<option value="PackagePages">Package Pages</option>
<option value="show" disabled="" class="disabled">------------------------</option>
<option value="Load">Load</option>
<option value="Save">Save</option>
<option value="SlideShow">SlideShow</option>
    </select>
    
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

<h1 id="locationline">


<ul id="pagelocation">
<li><a href="https://wiki.debian.org/EmDebian">EmDebian</a></li><li><a href="https://wiki.debian.org/EmDebian/CrossDebootstrap">CrossDebootstrap</a></li>
</ul>

</h1>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"></p><div class="table-of-contents"><p class="table-of-contents-heading">Contents</p><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Cross-installing_Debian_using_debootstrap.2Fmultistrap">Cross-installing Debian using debootstrap/multistrap</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Requirements">Requirements</a></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Multistrap">Multistrap</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Example_use">Example use</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Basic_usage">Basic usage</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#multiple_repository_usage">multiple repository usage</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#packages_from_multiple_components">packages from multiple components</a></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Configuring_the_rootfs">Configuring the rootfs</a></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#QEMU.2Fdebootstrap_approach">QEMU/debootstrap approach</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Installing_required_packages">Installing required packages</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Generating_cross_images_as_root_user">Generating cross images as root user</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Generating_cross_images_as_non-root_user">Generating cross images as non-root user</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Using_schroot">Using schroot</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Using_fakechroot">Using fakechroot</a></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Configuring_the_new_system_.28target_specific.29">Configuring the new system (target specific)</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Serial_console">Serial console</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Networking">Networking</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Apt">Apt</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#References">References</a></li></ol></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Real_Hardware.2Fcdebootstrap_approach">Real Hardware/cdebootstrap approach</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Second_attempt_using_debootstrap">Second attempt using debootstrap</a></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Unpacking_method">Unpacking method</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Issues_with_the_final_filesystem_image">Issues with the final filesystem image</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Issues_with_replacing_debconf_with_cdebconf">Issues with replacing debconf with cdebconf</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#A.2Fetc.2Fgroup_and_.2Fetc.2Fpasswd">/etc/group and /etc/passwd</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#ash.2C_not_bash">ash, not bash</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#busybox_applets.2C_not_coreutils">busybox applets, not coreutils</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#starting_init_processes">starting init processes</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Outputting_messages_to_the_user">Outputting messages to the user</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Calling_processes_within_debootstrap">Calling processes within debootstrap</a></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Method">Method</a><ol><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#approximate_time_and_SecureApt">approximate time and SecureApt</a></li></ol></li><li>
<a href="https://wiki.debian.org/EmDebian/CrossDebootstrap#Installing_the_image">Installing the image</a></li></ol></li></ol></div> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">
</p><h1 id="Cross-installing_Debian_using_debootstrap.2Fmultistrap">Cross-installing Debian using debootstrap/multistrap</h1>
<span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line874">(Nothing on this page is specific to emdebian, rather than debian) <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span></p><p class="line874">From debootstrap's manpage: <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span></p><ul><li style="list-style-type:none">"Debootstrap can be used to install Debian in a system without using an installation disk but can also be used to run a different Debian flavor in a chroot environment. This way you can create a full (minimal) Debian installation which can be used for testing purposes". <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span></li></ul><p class="line874">Basically, bootstrapping a Debian system involves four steps (some were ommitted for simplicity): <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></p><ol type="1"><li>Download the necessary .deb packages from a repository. <span class="anchor" id="line-14"></span></li><li>Unpack them into the target directory. <span class="anchor" id="line-15"></span></li><li>Chroot into the target directory. <span class="anchor" id="line-16"></span></li><li>Run the installation and configuration scripts from each package, finishing the setup. <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></li></ol><p class="line874">Usually, when doing cross-bootstrapping, steps 3 and 4 need to be done on the target side. This document explains how to bootstrap a Debian system for a target architecture different from the host's one, doing all steps on the host side and, optionally, using QEMU to run target executables. <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span></p><p class="line874">This is useful, for example, to create filesystem images without depending on the target board to be available. <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span></p><p class="line867">
</p><h2 id="Requirements">Requirements</h2>
<span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line862">There are lots of ways of doing this. You can use multistrap (recommended) or debootstrap or cdebootstrap for stages 1 and 2. And QEMU or real hardware for stages 3 &amp; 4. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span></p><p class="line874">Four variant approaches are described on this page: <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></p><ol type="1"><li>Multistrap + real hardware <span class="anchor" id="line-29"></span><ul><li>Multistrap + config script for rootfs creation <span class="anchor" id="line-30"></span></li><li>hardware or QEMU for configuration. <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></li></ul></li><li class="gap">QEMU <span class="anchor" id="line-33"></span><ul><li><p class="line862">QEMU with transparent user mode emulation (see <a href="https://wiki.debian.org/QemuUserEmulation">QemuUserEmulation</a>) <span class="anchor" id="line-34"></span></p></li><li><p class="line862">debootstrap, with patch (<a class="interwiki open-bug" href="https://bugs.debian.org/355801" title="Open in debootstrap/0.3.3: #355801: single-stage cross-debootstrap support using qemu">355801</a>) applied to support cross-bootstrapping <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span></p></li></ul></li><li class="gap">Real hardware <span class="anchor" id="line-37"></span><ul><li>An ARM machine which can mount an NFS root <span class="anchor" id="line-38"></span></li><li>cdebootstrap (in squeeze) <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></li></ul></li><li class="gap">Unpacking method <span class="anchor" id="line-41"></span><ul><li>Any Debian box, to support any ARM machine with serial, network or USB connectivity <span class="anchor" id="line-42"></span></li><li>emsandbox (debootstrap --foreign). <span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span></li></ul></li></ol><p class="line862">This page will try to stick to general issues around how a cross bootstrap differs from typical usage of debootstrap. See also <a href="https://wiki.debian.org/EmDebian/DeBootstrap">EmDebian/DeBootstrap</a> which deals with specific issues with particular boards or devices. <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span></p><p class="line874">Now there’s also 'debootstrap --foreign' + 'debootstrap --second-stage', which should erase the need to “re-install everything to get the configuration scripts run”. The author of this document is asked to look into this. --mirabilos <span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span></p><p class="line867">
</p><h1 id="Multistrap">Multistrap</h1>
<span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><p class="line867"><a href="https://wiki.debian.org/Multistrap">Multistrap</a> is a tool which does essentially the same job as Debootstrap but with a different design, giving a lot more flexibility, and a different set of pros/cons. It works in a completely different way by simply using apt and dpkg, rather than avoiding using them, which is how debootstrap works. It is focussed on producing rootfs images for devices, as opposed to chroots for existing machines, but in fact (like debootstrap) does both of these jobs almost equally well. <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span></p><p class="line874">Advantages: <span class="anchor" id="line-53"></span></p><ul><li>Can use packages from multiple repositories - uses normal apt resolution to choose set. This is very powerful - you can use debian as a base, plus some packages from a local repository, by listing the repositories to use and the set of top-level packages wanted from each. Debootstrap can't do this. <span class="anchor" id="line-54"></span></li><li>Doesn't need copies of every deb in /var/cache/apt/archives, so tarball approx half the size <span class="anchor" id="line-55"></span></li><li>Unpacks with dpkg so dpkg database already has packages marked 'unpacked': only postinst scripts need to be run to complete process. <span class="anchor" id="line-56"></span></li><li>Because it uses apt, all the normal apt features work (e.g. apt-cacher proxy, repository key checks, different apt methods (url, file), pinning) <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span></li></ul><p class="line874">Limitations: <span class="anchor" id="line-59"></span></p><ul><li>You need a real Debian-based system to run it on. Debootstrap can work on any system. <span class="anchor" id="line-60"></span></li><li><p class="line862">It needs a configuration file to run - you can't just do 'multistrap &lt;mirror&gt; squeeze' <span class="anchor" id="line-61"></span></p></li><li>Because it cannot run preinst scripts a few packages need specific fixup in the config script <span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span></li></ul><p class="line874">Multistrap creates the image from the packages needed; it does not make device/chroot-specific modifications. Most real devices need a set of such changes to operate (console, inittab, fstab, devicenodes, etc) and a script or manual changes are needed. It has hooks to help automate this sort of config. <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span></p><p class="line867"><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span></p><pre><span class="anchor" id="line-1"></span>apt-get install multistrap</pre><span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><p class="line867">
</p><h2 id="Example_use">Example use</h2>
<span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><p class="line867">
</p><h3 id="Basic_usage">Basic usage</h3>
<span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><p class="line874">To create a new image in targetdir for arch armel using repositories specified in multistrap.conf: <span class="anchor" id="line-74"></span>(both arch and dir can be specified in the config file too, if you prefer) <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span></p><pre><span class="anchor" id="line-1-1"></span># multistrap -a armel -d targetdir -f multistrap.conf</pre><span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><p class="line874">This is a minimal config which will make a grip rootfs using just the packages which are Priority: required <span class="anchor" id="line-80"></span>(essential is ignored by multistrap, making it much easier to only get what you want/need). Noauth stops secure-apt complaining about keys if no keyring package is specified. <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span></p><pre><span class="anchor" id="line-1-2"></span>[General]
<span class="anchor" id="line-2"></span>noauth=true
<span class="anchor" id="line-3"></span>unpack=true
<span class="anchor" id="line-4"></span>debootstrap=Grip
<span class="anchor" id="line-5"></span>aptsources=Grip
<span class="anchor" id="line-6"></span>
<span class="anchor" id="line-7"></span>[Grip]
<span class="anchor" id="line-8"></span># space separated package list
<span class="anchor" id="line-9"></span>source=http://www.emdebian.org/grip
<span class="anchor" id="line-10"></span>suite=lenny</pre><span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><p class="line874">The (tared-up) result is a 30Mb tarball (approx 50% apt cache contents). Adding <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span></p><pre><span class="anchor" id="line-1-3"></span>cleanup=true</pre><span class="anchor" id="line-98"></span><p class="line874">to the config removes the apt cache debs and lists, resulting in a 15Mb tarball. <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span></p><p class="line867">
</p><h3 id="multiple_repository_usage">multiple repository usage</h3>
<span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><p class="line874">This is a more complex example which uses four repositories: grip, debian (for extra packages not in grip), grip updates from proposed-updates, and a  local repository, as well as specifying some optional packages from those repositories. The important thing is that for every name listed in 'aptsources' you need a correspondingly named section containing at least source and suite. The use of keyring packages and specifying components other than the default of 'main' is also shown. <span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span></p><p class="line874">I've set the cleanup option (which tidies up /var/cache/apt/ ), the retainsources option (which keeps all downloaded debs in a directory so you have a copy of what was used to make this rootfs) and an example of setting the arch and target dir in the config instead of on the command line: <span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span></p><pre><span class="anchor" id="line-1-4"></span>[General]
<span class="anchor" id="line-2-1"></span>unpack=true
<span class="anchor" id="line-3-1"></span>debootstrap=Grip
<span class="anchor" id="line-4-1"></span>aptsources=Grip Updates Debian Localserver
<span class="anchor" id="line-5-1"></span>cleanup=true
<span class="anchor" id="line-6-1"></span>arch=armel
<span class="anchor" id="line-7-1"></span>directory=/tmp/targetdir/
<span class="anchor" id="line-8-1"></span>retainsources=/tmp/targetdir/sources
<span class="anchor" id="line-9-1"></span>
<span class="anchor" id="line-10-1"></span>[Grip]
<span class="anchor" id="line-11"></span>#space separated package list
<span class="anchor" id="line-12"></span>packages=udev ntpdate
<span class="anchor" id="line-13"></span>source=http://www.emdebian.org/grip
<span class="anchor" id="line-14"></span>keyring=emdebian-archive-keyring
<span class="anchor" id="line-15"></span>suite=lenny
<span class="anchor" id="line-16"></span>
<span class="anchor" id="line-17"></span>[Updates]
<span class="anchor" id="line-18"></span>packages=apt
<span class="anchor" id="line-19"></span>source=http://www.emdebian.org/grip
<span class="anchor" id="line-20"></span>keyring=emdebian-archive-keyring
<span class="anchor" id="line-21"></span>suite=lenny-proposed-updates
<span class="anchor" id="line-22"></span>
<span class="anchor" id="line-23"></span>[Debian]
<span class="anchor" id="line-24"></span>packages=erlang-nox
<span class="anchor" id="line-25"></span>source=http://ftp.uk.debian.org/debian
<span class="anchor" id="line-26"></span>keyring=debian-archive-keyring
<span class="anchor" id="line-27"></span>suite=lenny
<span class="anchor" id="line-28"></span>
<span class="anchor" id="line-29"></span>[Localserver]
<span class="anchor" id="line-30"></span>packages=sl40-platform-debian balloon3-config
<span class="anchor" id="line-31"></span>source=http://aptcache.localhost:4132/debian
<span class="anchor" id="line-32"></span>keyring=localrepo-archive-keyring
<span class="anchor" id="line-33"></span>suite=development</pre><span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><p class="line874">Running <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span></p><pre><span class="anchor" id="line-1-5"></span>sudo multistrap -f multistrap.conf</pre><span class="anchor" id="line-145"></span><p class="line874">updates package lists, takes packages from all 4 repositories (checking them against the specified keyrings) and builds the rootfs, clears out the apt-cache and saves all the debs in the directory specified in retainsources. <span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span></p><p class="line867">
</p><h3 id="packages_from_multiple_components">packages from multiple components</h3>
<span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><p class="line874">As of multistrap version v2.0.6, it is possible to use the "components=" option to load packages from components other than main. Here is an example to include a firmware package from non-free: <span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span></p><p class="line867"><span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span><span class="anchor" id="line-154"></span><span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span><span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span><span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span><span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span></p><pre><span class="anchor" id="line-1-6"></span>[General]
<span class="anchor" id="line-2-2"></span>noauth=true
<span class="anchor" id="line-3-2"></span>unpack=true
<span class="anchor" id="line-4-2"></span>debootstrap=Squeeze
<span class="anchor" id="line-5-2"></span>aptsources=Squeeze
<span class="anchor" id="line-6-2"></span>arch=armel
<span class="anchor" id="line-7-2"></span>
<span class="anchor" id="line-8-2"></span>[Squeeze]
<span class="anchor" id="line-9-2"></span>packages=wpasupplicant wireless-tools firmware-ralink
<span class="anchor" id="line-10-2"></span>source=http://ftp.au.debian.org/debian/
<span class="anchor" id="line-11-1"></span>keyring=debian-archive-keyring
<span class="anchor" id="line-12-1"></span>components=main non-free
<span class="anchor" id="line-13-1"></span>suite=squeeze</pre><span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span><p class="line867">
</p><h2 id="Configuring_the_rootfs">Configuring the rootfs</h2>
<span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span><p class="line874">The rootfs produced is chrootable, but often not bootable without fixing up a few files. See the QEMU/DeBootstrap section below for examples of the changes usually needed. Normaly it's best to script those changes for repeatability. <span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span></p><p class="line874">If you can, it usually easier to chroot into the rootfs (on an ARM machine, or using qemu) to configure it as less work is required than making it bootable. <span class="anchor" id="line-172"></span><span class="anchor" id="line-173"></span><span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span></p><pre><span class="anchor" id="line-1-7"></span>chroot /tmp/targetdir
<span class="anchor" id="line-2-3"></span>dpkg --configure -a</pre><span class="anchor" id="line-176"></span><p class="line874">will run all the postinst scripts of the installed packages and complete the rootfs generation process. Tar up the result and copy it onto your device. <span class="anchor" id="line-177"></span><span class="anchor" id="line-178"></span></p><p class="line874">Alternatively, if you can boot the image on the device then you can do the <span class="anchor" id="line-179"></span><span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></p><pre><span class="anchor" id="line-1-8"></span>dpkg --configure -a</pre><span class="anchor" id="line-182"></span><p class="line874">on the device directly. <span class="anchor" id="line-183"></span><span class="anchor" id="line-184"></span></p><p class="line874">In order to complete the configure of dash you should <span class="anchor" id="line-185"></span><span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span></p><pre><span class="anchor" id="line-1-9"></span>/var/lib/dpkg/info/dash.preinst install</pre><span class="anchor" id="line-188"></span><p class="line862">as described on the <a href="https://wiki.debian.org/Multistrap#Steps_for_Squeeze_and_later">Multistrap page</a>. <span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span></p><p class="line867">
</p><h1 id="QEMU.2Fdebootstrap_approach">QEMU/debootstrap approach</h1>
<span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span><p class="line867">
</p><h2 id="Installing_required_packages">Installing required packages</h2>
<span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><p class="line862">Install required packages using the following command: <span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span></p><pre><span class="anchor" id="line-1-10"></span># apt-get install binfmt-support qemu qemu-user-static debootstrap</pre><span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span><p class="line867">
</p><h2 id="Generating_cross_images_as_root_user">Generating cross images as root user</h2>
<span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span><p class="line874">The following steps need to be done as root, because debootstrap will create device nodes (using mknod) as well as chroot into the newly created system, which require root privileges. <span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span></p><ol type="1"><li>Choose the target's architecture and Debian suite (e.g. stable, testing, sid) you want to bootstrap. For this tutorial, we will choose the ARM target architecture and the stretch (AKA Debian testing) suite. <span class="anchor" id="line-204"></span><span class="anchor" id="line-205"></span></li><li class="gap">Choose a (empty) directory where you want the new system to be populated. This directory will reflect the root filesystem of the new system. Note that the host system is not affected in any way, and all modifications are restricted to the directory you have chosen. <span class="anchor" id="line-206"></span><span class="anchor" id="line-207"></span><p class="line891"><strong>Note:</strong> For the purposes of this document, we will use "debian_armel_stretch" as the target directory. Create this directory, if it does not exist already: <span class="anchor" id="line-208"></span><span class="anchor" id="line-209"></span></p><pre><span class="anchor" id="line-1-11"></span># mkdir debian_armel_stretch</pre><span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span></li><li class="gap"><p class="line862">To bootstrap the new system, just run qemu-debootstrap. E.g.: <span class="anchor" id="line-212"></span><span class="anchor" id="line-213"></span></p><pre><span class="anchor" id="line-1-12"></span># qemu-debootstrap --arch armel stretch debian_armel_stretch http://deb.debian.org/debian/</pre><span class="anchor" id="line-214"></span><span class="anchor" id="line-215"></span>where "debian_armel_stretch" is the directory you have created and "armel" is the target architecture. See debootstrap(8) manpage for more details about each parameter used above. <span class="anchor" id="line-216"></span><span class="anchor" id="line-217"></span><p class="line862">"<a class="http" href="http://deb.debian.org/debian/">http://deb.debian.org/debian/</a>" is the Debian mirror from which the necessary .deb packages will be downloaded. You are free to choose any mirror you like, as long as it has the architecture you are trying to bootstrap. See <a class="http" href="http://www.debian.org/mirror/list">http://www.debian.org/mirror/list</a> for the list of available Debian mirrors. <span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span></p></li><li class="gap">The new system is now created. By default, debootstrap creates a very minimal system, so you will probably want to extend it (see below 'Configuring the new system' for some instructions). <span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span></li></ol><p class="line867">
</p><h2 id="Generating_cross_images_as_non-root_user">Generating cross images as non-root user</h2>
<span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span><ul><li><p class="line862">Generate a configure file for multistrap (<em>armel.conf</em>) <span class="anchor" id="line-225"></span></p></li></ul><p class="line867"><span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span><span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><span class="anchor" id="line-241"></span><span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span><span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span><span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span><span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span><span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span><span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span><span class="anchor" id="line-254"></span><span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><span class="anchor" id="line-259"></span><span class="anchor" id="line-260"></span><span class="anchor" id="line-261"></span></p><pre><span class="anchor" id="line-1-13"></span>[General]
<span class="anchor" id="line-2-4"></span># arch and directory can be specified on the command line.
<span class="anchor" id="line-3-3"></span>arch=armel
<span class="anchor" id="line-4-3"></span>directory=/tmp/chroot_armel
<span class="anchor" id="line-5-3"></span>omitrequired=false
<span class="anchor" id="line-6-3"></span># same as --tidy-up option if set to true
<span class="anchor" id="line-7-3"></span>cleanup=true
<span class="anchor" id="line-8-3"></span># retain the sources outside the rootfs for distribution
<span class="anchor" id="line-9-3"></span># specify a directory to which all the .debs can be moved.
<span class="anchor" id="line-10-3"></span># or override with the --source-dir option.
<span class="anchor" id="line-11-2"></span>retainsources=
<span class="anchor" id="line-12-2"></span># same as --no-auth option if set to true
<span class="anchor" id="line-13-2"></span># keyring packages listed in each debootstrap will
<span class="anchor" id="line-14-1"></span># still be installed.
<span class="anchor" id="line-15-1"></span>noauth=true
<span class="anchor" id="line-16-1"></span># extract all downloaded archives
<span class="anchor" id="line-17-1"></span>unpack=true
<span class="anchor" id="line-18-1"></span># the order of sections is no longer important.
<span class="anchor" id="line-19-1"></span># debootstrap determines which repository is used to
<span class="anchor" id="line-20-1"></span># calculate the list of Priority: required packages
<span class="anchor" id="line-21-1"></span>debootstrap=Grip
<span class="anchor" id="line-22-1"></span># the order of sections is no longer important.
<span class="anchor" id="line-23-1"></span># aptsources is a list of sections to be listed
<span class="anchor" id="line-24-1"></span># in the /etc/apt/sources.list.d/multistrap.sources.list
<span class="anchor" id="line-25-1"></span># of the target.
<span class="anchor" id="line-26-1"></span>aptsources=Grip
<span class="anchor" id="line-27-1"></span>#configscript=config.sh
<span class="anchor" id="line-28-1"></span>#setupscript=setup.sh
<span class="anchor" id="line-29-1"></span>
<span class="anchor" id="line-30-1"></span>[Grip]
<span class="anchor" id="line-31-1"></span>packages=udev aptitude
<span class="anchor" id="line-32-1"></span>source=http://www.emdebian.org/grip
<span class="anchor" id="line-33-1"></span>keyring=emdebian-archive-keyring
<span class="anchor" id="line-34"></span>suite=lenny
<span class="anchor" id="line-35"></span>omitdebsrc=true</pre><span class="anchor" id="line-262"></span><span class="anchor" id="line-263"></span><ul><li>Generate the root filesystem with multistrap <span class="anchor" id="line-264"></span></li></ul><p class="line867"><span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span><span class="anchor" id="line-267"></span></p><pre><span class="anchor" id="line-1-14"></span>$ cd /tmp
<span class="anchor" id="line-2-5"></span>$ multistrap -a armel -f armel.conf -d chroot_armel</pre><span class="anchor" id="line-268"></span><span class="anchor" id="line-269"></span><ul><li>Alternatively generate a root filesystem with debootstrap <span class="anchor" id="line-270"></span></li></ul><p class="line867"><span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span></p><pre><span class="anchor" id="line-1-15"></span>$ fakeroot debootstrap --foreign --arch=armel sid $ROOTDIR</pre><span class="anchor" id="line-273"></span><span class="anchor" id="line-274"></span><ul><li>Add emulation layer <span class="anchor" id="line-275"></span></li></ul><p class="line867"><span class="anchor" id="line-276"></span><span class="anchor" id="line-277"></span></p><pre><span class="anchor" id="line-1-16"></span>$ cp /usr/bin/qemu-arm-static chroot_armel/usr/bin</pre><span class="anchor" id="line-278"></span><span class="anchor" id="line-279"></span><p class="line867">
</p><h3 id="Using_schroot">Using schroot</h3>
<span class="anchor" id="line-280"></span><span class="anchor" id="line-281"></span><ul><li><p class="line862">Install and configure schroot (<em>/etc/schroot/schroot.conf</em>) <span class="anchor" id="line-282"></span></p></li></ul><p class="line867"><span class="anchor" id="line-283"></span><span class="anchor" id="line-284"></span><span class="anchor" id="line-285"></span><span class="anchor" id="line-286"></span><span class="anchor" id="line-287"></span><span class="anchor" id="line-288"></span><span class="anchor" id="line-289"></span><span class="anchor" id="line-290"></span></p><pre><span class="anchor" id="line-1-17"></span>[chroot_armel]
<span class="anchor" id="line-2-6"></span>description=Debian armel cross chroot
<span class="anchor" id="line-3-4"></span>directory=/tmp/chroot_armel
<span class="anchor" id="line-4-4"></span>users=$USER
<span class="anchor" id="line-5-4"></span>groups=sbuild
<span class="anchor" id="line-6-4"></span>root-groups=root
<span class="anchor" id="line-7-4"></span>aliases=default</pre><span class="anchor" id="line-291"></span><span class="anchor" id="line-292"></span><ul><li>In order to bypass a QEmu limitation mapping lower memory addresses, you should configure your system with: <span class="anchor" id="line-293"></span></li></ul><p class="line867"><span class="anchor" id="line-294"></span><span class="anchor" id="line-295"></span></p><pre><span class="anchor" id="line-1-18"></span>$ sudo sh -c "echo 0 &gt; /proc/sys/vm/mmap_min_addr"</pre><span class="anchor" id="line-296"></span><span class="anchor" id="line-297"></span><ul><li>schroot into the root filesystem as user (any time) <span class="anchor" id="line-298"></span></li></ul><p class="line867"><span class="anchor" id="line-299"></span><span class="anchor" id="line-300"></span></p><pre><span class="anchor" id="line-1-19"></span>$ schroot -c chroot_armel</pre><span class="anchor" id="line-301"></span><span class="anchor" id="line-302"></span><p class="line867">
</p><h3 id="Using_fakechroot">Using fakechroot</h3>
<span class="anchor" id="line-303"></span><span class="anchor" id="line-304"></span><ul><li>Create a symlink as root under /lib, otherwise it does not work <span class="anchor" id="line-305"></span></li></ul><p class="line867"><span class="anchor" id="line-306"></span><span class="anchor" id="line-307"></span></p><pre><span class="anchor" id="line-1-20"></span>$ sudo ln -sf /tmp/chroot_armel/lib/ld-linux.so.3 /lib/ld-linux.so.3</pre><span class="anchor" id="line-308"></span><span class="anchor" id="line-309"></span><ul><li>Execute chroot as follows ignoring ERROR messages <span class="anchor" id="line-310"></span></li></ul><p class="line867"><span class="anchor" id="line-311"></span><span class="anchor" id="line-312"></span></p><pre><span class="anchor" id="line-1-21"></span>$ LD_LIBRARY_PATH=$(pwd)/chroot_armel/usr/lib/fakechroot fakechroot /usr/sbin/chroot $(pwd)/chroot_armel/ /bin/pwd</pre><span class="anchor" id="line-313"></span><span class="anchor" id="line-314"></span><p class="line867">
</p><h2 id="Configuring_the_new_system_.28target_specific.29">Configuring the new system (target specific)</h2>
<span class="anchor" id="line-315"></span><span class="anchor" id="line-316"></span><p class="line874">The system you have just created needs a few tweaks so you can use it for specific tasks. The following steps need to be done as root, as the files touched are owned by root. <span class="anchor" id="line-317"></span><span class="anchor" id="line-318"></span></p><ol type="1"><li><p class="line862">First create a fixed symlink to the directory where the new system was bootstrapped: <span class="anchor" id="line-319"></span><span class="anchor" id="line-320"></span></p><pre><span class="anchor" id="line-1-22"></span># ln -sfn /full/path/to/debian_armel_wheezy/ /armelfs_debian</pre><span class="anchor" id="line-321"></span><span class="anchor" id="line-322"></span></li><li class="gap"><p class="line862">Mount the proc filesystem on the target so the next commands can run properly: <span class="anchor" id="line-323"></span><span class="anchor" id="line-324"></span></p><pre><span class="anchor" id="line-1-23"></span># mount -t proc proc /armelfs_debian/proc</pre><span class="anchor" id="line-325"></span><span class="anchor" id="line-326"></span></li></ol><p class="line867">
</p><h3 id="Serial_console">Serial console</h3>
<span class="anchor" id="line-327"></span><span class="anchor" id="line-328"></span><ol type="1"><li><p class="line862">Edit /armelfs_debian/etc/inittab and add the following line at the bottom: <span class="anchor" id="line-329"></span><span class="anchor" id="line-330"></span></p><pre><span class="anchor" id="line-1-24"></span>T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100</pre><span class="anchor" id="line-331"></span><span class="anchor" id="line-332"></span><p class="line862">also comment out the following lines (virtual consoles are not needed for our purposes): <span class="anchor" id="line-333"></span><span class="anchor" id="line-334"></span><span class="anchor" id="line-335"></span><span class="anchor" id="line-336"></span><span class="anchor" id="line-337"></span><span class="anchor" id="line-338"></span><span class="anchor" id="line-339"></span></p><pre><span class="anchor" id="line-1-25"></span>1:2345:respawn:/sbin/getty 38400 tty1
<span class="anchor" id="line-2-7"></span>2:23:respawn:/sbin/getty 38400 tty2
<span class="anchor" id="line-3-5"></span>3:23:respawn:/sbin/getty 38400 tty3
<span class="anchor" id="line-4-5"></span>4:23:respawn:/sbin/getty 38400 tty4
<span class="anchor" id="line-5-5"></span>5:23:respawn:/sbin/getty 38400 tty5
<span class="anchor" id="line-6-5"></span>6:23:respawn:/sbin/getty 38400 tty6</pre><span class="anchor" id="line-340"></span><span class="anchor" id="line-341"></span></li><li class="gap"><p class="line862">Create the "ttyS0" device node on the target so the serial console can be used: <span class="anchor" id="line-342"></span><span class="anchor" id="line-343"></span></p><pre><span class="anchor" id="line-1-26"></span># chroot /armelfs_debian sh -c "cd /dev; ./MAKEDEV ttyS0"</pre><span class="anchor" id="line-344"></span><span class="anchor" id="line-345"></span></li></ol><p class="line867">
</p><h3 id="Networking">Networking</h3>
<span class="anchor" id="line-346"></span><span class="anchor" id="line-347"></span><p class="line862">Copy the /etc/hosts file from the host to the target system, so networking can work properly inside the chroot: <span class="anchor" id="line-348"></span><span class="anchor" id="line-349"></span></p><pre><span class="anchor" id="line-1-27"></span># cp /etc/hosts /armelfs_debian/etc/</pre><span class="anchor" id="line-350"></span><span class="anchor" id="line-351"></span><p class="line867">
</p><h3 id="Apt">Apt</h3>
<span class="anchor" id="line-352"></span><span class="anchor" id="line-353"></span><ol type="1"><li><p class="line862">Run apt-setup to create a new /etc/apt/sources.list for the target: <span class="anchor" id="line-354"></span><span class="anchor" id="line-355"></span></p><pre><span class="anchor" id="line-1-28"></span># LC_ALL=C chroot /armelfs_debian apt-setup</pre><span class="anchor" id="line-356"></span><span class="anchor" id="line-357"></span></li><li class="gap"><p class="line862">Select "edit sources list by hand" and add the following entries: <span class="anchor" id="line-358"></span><span class="anchor" id="line-359"></span><span class="anchor" id="line-360"></span></p><pre><span class="anchor" id="line-1-29"></span>deb http://ftp.debian.org/debian/ wheezy main contrib non-free
<span class="anchor" id="line-2-8"></span>deb-src http://ftp.debian.org/debian/ wheezy main contrib non-free</pre><span class="anchor" id="line-361"></span><span class="anchor" id="line-362"></span>Feel free to use other mirrors (as long as it supports the target platform). <span class="anchor" id="line-363"></span><span class="anchor" id="line-364"></span></li><li class="gap">After downloading the packages list, it will ask whether you want to add other sources. Select "no". <span class="anchor" id="line-365"></span><span class="anchor" id="line-366"></span></li></ol><p class="line862">Done! You can now install other packages using <tt>apt-get&nbsp;install&nbsp;&lt;package&gt;</tt> as usual. <span class="anchor" id="line-367"></span><span class="anchor" id="line-368"></span></p><p class="line867">
</p><h3 id="References">References</h3>
<span class="anchor" id="line-369"></span><span class="anchor" id="line-370"></span><ul><li><p class="line891"><a class="http" href="http://azure.humbug.org.au/~aj/blog/debian/debootstrap">http://azure.humbug.org.au/~aj/blog/debian/debootstrap</a> <span class="anchor" id="line-371"></span></p></li><li><p class="line891"><a href="https://wiki.debian.org/QemuUserEmulation">QemuUserEmulation</a> <span class="anchor" id="line-372"></span></p></li><li>debootstrap(8) manpage <span class="anchor" id="line-373"></span><span class="anchor" id="line-374"></span></li></ul><p class="line867">
</p><h1 id="Real_Hardware.2Fcdebootstrap_approach">Real Hardware/cdebootstrap approach</h1>
<span class="anchor" id="line-375"></span><span class="anchor" id="line-376"></span><p class="line874">We will: <span class="anchor" id="line-377"></span></p><ul><li>Run cdeboostrap (or debootstrap) to set up the basic root filesystem <span class="anchor" id="line-378"></span></li><li>boot into it, mounting it over NFS <span class="anchor" id="line-379"></span></li><li>Install everything again in order to get all the post-install scripts run <span class="anchor" id="line-380"></span><span class="anchor" id="line-381"></span></li></ul><p class="line874">This is a rather brute-force approach but it works. This was tested with the Oct 2006 version of cdebootstrap in unstable. <span class="anchor" id="line-382"></span><span class="anchor" id="line-383"></span><span class="anchor" id="line-384"></span></p><pre><span class="anchor" id="line-1-30"></span># cdebootstrap --arch=armel testing /testing-armel-chroot http://ftp.uk.debian.org/debian/</pre><span class="anchor" id="line-385"></span><span class="anchor" id="line-386"></span><p class="line874">I found that if you didn't specify a mirror then it just stopped after 4 lines and failed ot find a Packages file. <span class="anchor" id="line-387"></span><span class="anchor" id="line-388"></span></p><p class="line874">this will unpack everything (into '/testing-armel-chroot') then error out. <span class="anchor" id="line-389"></span><span class="anchor" id="line-390"></span></p><p class="line874">make sure that your testing-armel-chroot dir is accessible over NFS by editing /etc/exports and running exportfs -r to re-read the config then exportfs to check it is exported. Export it with options rw,no-root-squash,async. <span class="anchor" id="line-391"></span><span class="anchor" id="line-392"></span></p><p class="line862">No device files have been created so you will need to create /dev/ttyS0 at least: <span class="anchor" id="line-393"></span><span class="anchor" id="line-394"></span></p><pre><span class="anchor" id="line-1-31"></span># mknod /testing-armel-chroot/dev/ttyS0 c 4 64"</pre><p class="line862"> or in my case <span class="anchor" id="line-395"></span><span class="anchor" id="line-396"></span></p><pre><span class="anchor" id="line-1-32"></span># mknod /testing-armel-chroot/dev/ttyAMA0 c 204 16</pre><span class="anchor" id="line-397"></span><span class="anchor" id="line-398"></span><p class="line862">Now start up your hardware with an NFS-capable kernel with kernel arguments something like:<span class="anchor" id="line-399"></span><span class="anchor" id="line-400"></span></p><pre><span class="anchor" id="line-1-33"></span># root=/dev/nfs nfsroot=hostname:/testing-armel-chroot init=/bin/sh console=/dev/ttyS0</pre><span class="anchor" id="line-401"></span><span class="anchor" id="line-402"></span><p class="line874">You need to specify /bin/sh as the init because there is no inittab file and even if you add one you won't be able to login because login/pam are not set up properly. <span class="anchor" id="line-403"></span><span class="anchor" id="line-404"></span></p><p class="line862">Once you have a prompt you can <span class="anchor" id="line-405"></span><span class="anchor" id="line-406"></span></p><pre><span class="anchor" id="line-1-34"></span># cd /var/cache/boostrap</pre><p class="line874"> and run all the install scripts.<span class="anchor" id="line-407"></span><span class="anchor" id="line-408"></span></p><p class="line862">One way to do this (there may well be a better way) is just to do <tt>dpkg&nbsp;-i&nbsp;*.deb</tt> which re-installs everything. In order to avoid base-files failing to install over itself I did <tt>rm&nbsp;/var/mail</tt> before this. I found that dpkg gave the error <tt>dpkg:&nbsp;dpkg&nbsp;-&nbsp;error:&nbsp;PATH&nbsp;is&nbsp;not&nbsp;set</tt> so in fact the command line to use is <span class="anchor" id="line-409"></span><span class="anchor" id="line-410"></span></p><pre><span class="anchor" id="line-1-35"></span># PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin dpkg -i *.deb</pre><span class="anchor" id="line-411"></span><span class="anchor" id="line-412"></span><p class="line862">(get the path by doing <tt>set</tt> ) <span class="anchor" id="line-413"></span><span class="anchor" id="line-414"></span></p><p class="line862">This mostly works but some packages fail to install and you get to go back and do <span class="anchor" id="line-415"></span><span class="anchor" id="line-416"></span></p><pre><span class="anchor" id="line-1-36"></span># PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin dpkg -i &lt;packages which failed&gt;</pre><span class="anchor" id="line-417"></span><span class="anchor" id="line-418"></span><p class="line874">once you have got everything in, you should have a standard debian rootfs for the target arch. <span class="anchor" id="line-419"></span><span class="anchor" id="line-420"></span></p><p class="line874">And it works for me. There is no editor or networking installed after this so you can't do much without installing some more packages. <span class="anchor" id="line-421"></span><span class="anchor" id="line-422"></span></p><p class="line867">
</p><h2 id="Second_attempt_using_debootstrap">Second attempt using debootstrap</h2>
<span class="anchor" id="line-423"></span><span class="anchor" id="line-424"></span><p class="line874">deboostrap is equivalent to cdebootstrap, but is shell rather than c. Again you need to give a mirror that has the packages for your architecture otherwise it will give about 4 lines of output and then stop when it fails to find packages files. Your existing sources.list does not appear to get used as a default. <span class="anchor" id="line-425"></span><span class="anchor" id="line-426"></span></p><p class="line867"><span class="anchor" id="line-427"></span><span class="anchor" id="line-428"></span></p><pre><span class="anchor" id="line-1-37"></span># debootstrap --verbose --arch armel --foreign --variant=buildd sid sid-armel-chroot http://ftp.uk.debian.org/debian/</pre><span class="anchor" id="line-429"></span><span class="anchor" id="line-430"></span><span class="anchor" id="line-431"></span><p class="line862">So, as above create a suitable serial console dev file: <span class="anchor" id="line-432"></span><span class="anchor" id="line-433"></span></p><pre><span class="anchor" id="line-1-38"></span># mknod /sid-armel-chroot/dev/ttyAMA0 c 204 16</pre><span class="anchor" id="line-434"></span><span class="anchor" id="line-435"></span><p class="line874">Then boot into the new chroot, and install everything again, as above. Making debootstrap at least fill in the package database so that we could run all the install scripts more neatly would be good. I'm sure debootstrap could do this for us. <span class="anchor" id="line-436"></span><span class="anchor" id="line-437"></span></p><p class="line867">
</p><h1 id="Unpacking_method">Unpacking method</h1>
<span class="anchor" id="line-438"></span><span class="anchor" id="line-439"></span><p class="line874">We will: <span class="anchor" id="line-440"></span></p><ul><li>Prepare a package set from the Emdebian repository and download the .deb files using debootstrap --foreign <span class="anchor" id="line-441"></span></li><li>Unpack each .deb using dpkg to create a filesystem image <span class="anchor" id="line-442"></span></li><li>Outline how this filesystem needs to be tweaked to support init with the reduced package set <span class="anchor" id="line-443"></span><span class="anchor" id="line-444"></span></li></ul><p class="line862">emsandbox is a wrapper for debootstrap that tries to handle the issues around --foreign. The weakness of the normal --second-stage support in debootstrap is that it puts a <strong>large</strong> burden on the target device. Downloaded packages are copied into the root filesystem unchanged, then unpacked, configured and installed on the real device. Recent versions of emsandbox use an "unpacking" method that avoids the need to carry the .deb package files into the actual installed root filesystem tarball. This reduces the size of the rootfs tarball and decreases the workload for the target device. <span class="anchor" id="line-445"></span><span class="anchor" id="line-446"></span></p><p class="line874">emsandbox uses the Emdebian repository where package dependencies have been modified to support a much smaller root filesystem - around 24Mb installed instead of 180Mb - and the method can be extended to make even smaller images by using uClibc or not using apt etc. <span class="anchor" id="line-447"></span><span class="anchor" id="line-448"></span></p><p class="line862">This method can only support such small images if the appropriate packages already exist in the Emdebian repository or some other repository that can be used by debootstrap. emsandbox uses debootstrap to resolve the dependencies of the base and required packages but the normal --second-stage is much less work (consisting primarily of <tt>dpkg&nbsp;--configure&nbsp;-a</tt>). --second-stage itself is still used but is generally just a hook for machine:variant customisation scripting. <span class="anchor" id="line-449"></span><span class="anchor" id="line-450"></span></p><p class="line867">
</p><h2 id="Issues_with_the_final_filesystem_image">Issues with the final filesystem image</h2>
<span class="anchor" id="line-451"></span><span class="anchor" id="line-452"></span><p class="line862">By modifiying the basic set of packages used by debootstrap, the normal Debian init support needs to be hacked. Principally, using busybox instead of coreutils and sysv-rc means that runlevels are not supported and <tt>/etc/inittab</tt> needs to be compatible with busybox. <span class="anchor" id="line-453"></span><span class="anchor" id="line-454"></span></p><p class="line862">Other components of a standard Debian debootstrap environment may also be missing, e.g. <tt>/sys/</tt>. emsandbox can create these directories for you via the <tt>suite&nbsp;script</tt> that is used for debootstrap. <span class="anchor" id="line-455"></span><span class="anchor" id="line-456"></span></p><p class="line867">
</p><h2 id="Issues_with_replacing_debconf_with_cdebconf">Issues with replacing debconf with cdebconf</h2>
<span class="anchor" id="line-457"></span><span class="anchor" id="line-458"></span><p class="line862">See Debian bug <a class="interwiki closed-bug" href="https://bugs.debian.org/451130" title="Closed in cdebconf/0.157: #451130: cdebconf deb does not initalise the template database, which is needed to work out of the box">451130</a>. emsandbox will use a workaround to ensure that cdebconf initialises the debconf database until <a class="interwiki closed-bug" href="https://bugs.debian.org/451130" title="Closed in cdebconf/0.157: #451130: cdebconf deb does not initalise the template database, which is needed to work out of the box">451130</a> is closed. The command is: <span class="anchor" id="line-459"></span><span class="anchor" id="line-460"></span><span class="anchor" id="line-461"></span></p><pre><span class="anchor" id="line-1-39"></span>chroot $BUILDPLACE /usr/lib/cdebconf/debconf-loadtemplate /usr/share/debconf/demo /usr/share/debconf/demo.templates</pre><span class="anchor" id="line-462"></span><span class="anchor" id="line-463"></span><p class="line874">To use cdebconf at all, an environment variable also needs to be exported: <span class="anchor" id="line-464"></span><span class="anchor" id="line-465"></span><span class="anchor" id="line-466"></span><span class="anchor" id="line-467"></span></p><pre><span class="anchor" id="line-1-40"></span>DEBCONF_USE_CDEBCONF=true
<span class="anchor" id="line-2-9"></span>export DEBCONF_USE_CDEBCONF</pre><span class="anchor" id="line-468"></span><span class="anchor" id="line-469"></span><p class="line874">Normal debconf behaviour can be disabled using the expected debconf environment variable support: <span class="anchor" id="line-470"></span><span class="anchor" id="line-471"></span><span class="anchor" id="line-472"></span><span class="anchor" id="line-473"></span><span class="anchor" id="line-474"></span></p><pre><span class="anchor" id="line-1-41"></span>DEBIAN_FRONTEND=noninteractive
<span class="anchor" id="line-2-10"></span>DEBCONF_NONINTERACTIVE_SEEN=true
<span class="anchor" id="line-3-6"></span>export DEBIAN_FRONTEND DEBCONF_NONINTERACTIVE_SEEN</pre><span class="anchor" id="line-475"></span><span class="anchor" id="line-476"></span><p class="line867">
</p><h2 id="A.2Fetc.2Fgroup_and_.2Fetc.2Fpasswd">/etc/group and /etc/passwd</h2>
<span class="anchor" id="line-477"></span><span class="anchor" id="line-478"></span><p class="line862">Minimal versions of these files <strong>must</strong> exist before <tt>dpkg&nbsp;--configure&nbsp;-a</tt> is run, principally because the unpacking method avoids the need for packages to be processed in a particular sequence so emsandbox cannot rely on files being created in the postinst or preinst maintainer scripts. This also allows emsandbox to support arbitrary package sets where the packages that would create these files on a normal Debian box are simply omitted. <span class="anchor" id="line-479"></span><span class="anchor" id="line-480"></span></p><p class="line862">Support for creating these files is available via emsandbox using the <tt>suite&nbsp;script</tt> support in debootstrap. <span class="anchor" id="line-481"></span><span class="anchor" id="line-482"></span></p><p class="line867">
</p><h2 id="ash.2C_not_bash">ash, not bash</h2>
<span class="anchor" id="line-483"></span><span class="anchor" id="line-484"></span><p class="line874">busybox does not support bash, so all shell code used by emsandbox must be POSIX compliant - do not use bashisms. <span class="anchor" id="line-485"></span><span class="anchor" id="line-486"></span></p><p class="line867">
</p><h2 id="busybox_applets.2C_not_coreutils">busybox applets, not coreutils</h2>
<span class="anchor" id="line-487"></span><span class="anchor" id="line-488"></span><p class="line874">Various commands in Debian have a wider option set than the busybox equivalent. Examples are numerous but some of the most common include: <span class="anchor" id="line-489"></span></p><ul><li>fgrep does not support -x <span class="anchor" id="line-490"></span></li><li>start-stop-daemon does not support --oknodo or --retry <span class="anchor" id="line-491"></span></li><li>... <span class="anchor" id="line-492"></span><span class="anchor" id="line-493"></span></li></ul><p class="line862">Packages using such options will be patched in the Emdebian version - note that this may cause unexpected behaviour, in which case a bug should be filed against the package in Debian, requesting support for the busybox implementation, using <tt>embug&nbsp;--prepare</tt>. <span class="anchor" id="line-494"></span><span class="anchor" id="line-495"></span></p><p class="line867">
</p><h2 id="starting_init_processes">starting init processes</h2>
<span class="anchor" id="line-496"></span><span class="anchor" id="line-497"></span><p class="line862">Various packages will put scripts into <tt>/etc/init.d/</tt> and expect those scripts to be symlinked in directories like <tt>/etc/rc2.d/</tt> etc. which will not exist in a busybox init due to the lack of runlevel support. Work is ongoing in emsandbox to create a usable support mechanism for this issue but will probably involve using <tt>/etc/rcS.d/</tt> to hold the symlinks and calling each via the <tt>/etc/init.d/rcS</tt> script. Again, the <tt>suite&nbsp;script</tt> will provide support for setting up these symlinks. <span class="anchor" id="line-498"></span><span class="anchor" id="line-499"></span></p><p class="line867">
</p><h2 id="Outputting_messages_to_the_user">Outputting messages to the user</h2>
<span class="anchor" id="line-500"></span><span class="anchor" id="line-501"></span><p class="line874">This method still uses debootstrap so the normal STDOUT file descriptor is wrapped within debootstrap functions. <span class="anchor" id="line-502"></span><span class="anchor" id="line-503"></span></p><p class="line874">To output to the user, use debootstrap support functions: <span class="anchor" id="line-504"></span><span class="anchor" id="line-505"></span><span class="anchor" id="line-506"></span></p><pre><span class="anchor" id="line-1-42"></span>info INSTCORE "message"</pre><span class="anchor" id="line-507"></span><span class="anchor" id="line-508"></span><p class="line867">
</p><h2 id="Calling_processes_within_debootstrap">Calling processes within debootstrap</h2>
<span class="anchor" id="line-509"></span><span class="anchor" id="line-510"></span><p class="line862">Other functions are also available, like <tt>in_target</tt> to ensure that a process is actioned within the filesystem image using the chroot command. <span class="anchor" id="line-511"></span><span class="anchor" id="line-512"></span></p><p class="line867">
</p><h2 id="Method">Method</h2>
<span class="anchor" id="line-513"></span><span class="anchor" id="line-514"></span><p class="line862">Instead of a complicated set of shell instructions in the --second-stage function, the intention is to provide a series of shell functions accessible via emsandbox and empbuilderlib from emdebian-tools to provide the necessary support. The <tt>suite&nbsp;script</tt> is a shell script called by debootstrap and which normally describes how debootstrap should create a chroot for the Debian suite, i.e. testing, unstable, etc. Emdebian co-opts this debootstrap support to describe how debootstrap should create a filesystem image using the package set available from Emdebian. In effect, emsandbox tells debootstrap that each customised emsandbox filesystem image is a different suite of Debian. The first part of the <tt>suite&nbsp;script</tt> simply sets out the names of the packages to be downloaded from the Emdebian repository by debootstrap. This is the <tt>work_out_debs&nbsp;()</tt> function. <span class="anchor" id="line-515"></span><span class="anchor" id="line-516"></span></p><p class="line867"><span class="anchor" id="line-517"></span><span class="anchor" id="line-518"></span><span class="anchor" id="line-519"></span><span class="anchor" id="line-520"></span><span class="anchor" id="line-521"></span><span class="anchor" id="line-522"></span><span class="anchor" id="line-523"></span><span class="anchor" id="line-524"></span><span class="anchor" id="line-525"></span><span class="anchor" id="line-526"></span><span class="anchor" id="line-527"></span><span class="anchor" id="line-528"></span></p><pre><span class="anchor" id="line-1-43"></span>work_out_debs () {
<span class="anchor" id="line-2-11"></span>
<span class="anchor" id="line-3-7"></span>        required="busybox dpkg libstdc++6 libgcc1 libc6 cdebconf
<span class="anchor" id="line-4-6"></span>        libdebian-installer4 zlib1g libnewt0.52 libslang2"
<span class="anchor" id="line-5-6"></span>
<span class="anchor" id="line-6-6"></span>        base="apt gpgv libncurses5 libreadline5 readline-common mktemp
<span class="anchor" id="line-7-5"></span>        debconf-shell debianutils makedev base-passwd whiptail
<span class="anchor" id="line-8-4"></span>        gnupg udev base-files debian-archive-keyring udhcpc udhcpd sysv-rc
<span class="anchor" id="line-9-4"></span>        util-linux module-init-tools initscripts"
<span class="anchor" id="line-10-4"></span>
<span class="anchor" id="line-11-3"></span>}</pre><span class="anchor" id="line-529"></span><span class="anchor" id="line-530"></span><p class="line862">The distinction between <strong>required</strong> and <strong>base</strong> is lost if the unpacking method is used but debootstrap does require that some packages exist in each section. (In normal debootstrap, <strong>required</strong> packages are partially unpacked, <strong>base</strong> are not but the .debs are retained for both sets.) <span class="anchor" id="line-531"></span><span class="anchor" id="line-532"></span></p><p class="line862">To solve problems of code duplication, a set of common functions is available in empbuilderlib that can be called as part of the <tt>first_stage_install&nbsp;()&nbsp;</tt> function in the <tt>suite&nbsp;script</tt>. <span class="anchor" id="line-533"></span><span class="anchor" id="line-534"></span></p><p class="line862">The eventual <tt>suite&nbsp;script</tt> can look something like this: <span class="anchor" id="line-535"></span><span class="anchor" id="line-536"></span></p><p class="line867"><span class="anchor" id="line-537"></span><span class="anchor" id="line-538"></span><span class="anchor" id="line-539"></span><span class="anchor" id="line-540"></span><span class="anchor" id="line-541"></span><span class="anchor" id="line-542"></span><span class="anchor" id="line-543"></span><span class="anchor" id="line-544"></span><span class="anchor" id="line-545"></span><span class="anchor" id="line-546"></span><span class="anchor" id="line-547"></span><span class="anchor" id="line-548"></span><span class="anchor" id="line-549"></span><span class="anchor" id="line-550"></span><span class="anchor" id="line-551"></span><span class="anchor" id="line-552"></span><span class="anchor" id="line-553"></span><span class="anchor" id="line-554"></span><span class="anchor" id="line-555"></span><span class="anchor" id="line-556"></span><span class="anchor" id="line-557"></span><span class="anchor" id="line-558"></span><span class="anchor" id="line-559"></span><span class="anchor" id="line-560"></span><span class="anchor" id="line-561"></span><span class="anchor" id="line-562"></span><span class="anchor" id="line-563"></span><span class="anchor" id="line-564"></span><span class="anchor" id="line-565"></span><span class="anchor" id="line-566"></span><span class="anchor" id="line-567"></span><span class="anchor" id="line-568"></span><span class="anchor" id="line-569"></span><span class="anchor" id="line-570"></span><span class="anchor" id="line-571"></span><span class="anchor" id="line-572"></span><span class="anchor" id="line-573"></span><span class="anchor" id="line-574"></span><span class="anchor" id="line-575"></span><span class="anchor" id="line-576"></span><span class="anchor" id="line-577"></span><span class="anchor" id="line-578"></span><span class="anchor" id="line-579"></span><span class="anchor" id="line-580"></span><span class="anchor" id="line-581"></span><span class="anchor" id="line-582"></span><span class="anchor" id="line-583"></span><span class="anchor" id="line-584"></span><span class="anchor" id="line-585"></span><span class="anchor" id="line-586"></span><span class="anchor" id="line-587"></span><span class="anchor" id="line-588"></span><span class="anchor" id="line-589"></span><span class="anchor" id="line-590"></span></p><pre><span class="anchor" id="line-1-44"></span>mirror_style release
<span class="anchor" id="line-2-12"></span>download_style apt
<span class="anchor" id="line-3-8"></span>
<span class="anchor" id="line-4-7"></span>work_out_debs () {
<span class="anchor" id="line-5-7"></span>
<span class="anchor" id="line-6-7"></span>        required="busybox dpkg libstdc++6 libgcc1 libc6 cdebconf
<span class="anchor" id="line-7-6"></span>        libdebian-installer4 zlib1g libnewt0.52 libslang2"
<span class="anchor" id="line-8-5"></span>
<span class="anchor" id="line-9-5"></span>        base="apt gpgv libncurses5 libreadline5 readline-common mktemp
<span class="anchor" id="line-10-5"></span>        debconf-shell debianutils makedev base-passwd whiptail
<span class="anchor" id="line-11-4"></span>        gnupg udev base-files debian-archive-keyring udhcpc udhcpd sysv-rc
<span class="anchor" id="line-12-3"></span>        util-linux module-init-tools initscripts"
<span class="anchor" id="line-13-3"></span>}
<span class="anchor" id="line-14-2"></span>
<span class="anchor" id="line-15-2"></span>first_stage_install () {
<span class="anchor" id="line-16-2"></span>        . /usr/lib/emdebian-tools/empbuilderlib
<span class="anchor" id="line-17-2"></span>        extract $required
<span class="anchor" id="line-18-2"></span>        dpkg_support
<span class="anchor" id="line-19-2"></span>        dummy_fstab
<span class="anchor" id="line-20-2"></span>        dummy_resolvconf
<span class="anchor" id="line-21-2"></span>        dummy_hostname
<span class="anchor" id="line-22-2"></span>        dummy_hosts
<span class="anchor" id="line-23-2"></span>        setup_devices
<span class="anchor" id="line-24-2"></span>        make_proc
<span class="anchor" id="line-25-2"></span>        make_varlog
<span class="anchor" id="line-26-2"></span>        make_varspool
<span class="anchor" id="line-27-2"></span>        info INSTCORE "Setting up dpkg"
<span class="anchor" id="line-28-2"></span>        x_feign_install dpkg
<span class="anchor" id="line-29-2"></span>        info INSTCORE "Unpacking debootstrapped environment"
<span class="anchor" id="line-30-2"></span>        unpack_debootstrap
<span class="anchor" id="line-31-2"></span>}
<span class="anchor" id="line-32-2"></span>
<span class="anchor" id="line-33-2"></span>second_stage_install () {
<span class="anchor" id="line-34-1"></span>        if [ -f datestring ]; then
<span class="anchor" id="line-35-1"></span>                TIME=`cat datestring`
<span class="anchor" id="line-36"></span>                info INSTCORE "Setting approximate time of $TIME"
<span class="anchor" id="line-37"></span>                date -s $TIME
<span class="anchor" id="line-38"></span>        fi
<span class="anchor" id="line-39"></span>        info INSTCORE "Running ldconfig..."
<span class="anchor" id="line-40"></span>        in_target /sbin/ldconfig
<span class="anchor" id="line-41"></span>        info INSTCORE "Running depmod..."
<span class="anchor" id="line-42"></span>        in_target depmod
<span class="anchor" id="line-43"></span>        setup_cdebconf
<span class="anchor" id="line-44"></span>        info INSTCORE "Configuring ..."
<span class="anchor" id="line-45"></span>        in_target dpkg --configure -a
<span class="anchor" id="line-46"></span>        if [ ! -e "$TARGET/etc/localtime" ]; then
<span class="anchor" id="line-47"></span>                ln -sf /usr/share/zoneinfo/UTC "$TARGET/etc/localtime"
<span class="anchor" id="line-48"></span>        fi
<span class="anchor" id="line-49"></span>        if [ -f 0x97BB3B58.txt ]; then
<span class="anchor" id="line-50"></span>                rm 0x97BB3B58.txt
<span class="anchor" id="line-51"></span>        fi
<span class="anchor" id="line-52"></span>        info BASESUCCESS "Emdebian base system installed successfully."
<span class="anchor" id="line-53"></span>}</pre><span class="anchor" id="line-591"></span><span class="anchor" id="line-592"></span><p class="line862">The main work is carried out in <tt>unpack_debootstrap</tt> which feigns the unpacking and installation of the .deb packages using <tt>dpkg</tt> support <strong>but without running any maintainer scripts, including preinst</strong>. This allows emsandbox to create an almost functional filesystem image, leaving only the absolute minimum amount of work to be done on the target device before rebooting. <span class="anchor" id="line-593"></span><span class="anchor" id="line-594"></span></p><p class="line862">Via support for <tt>emsecondstage</tt>, each stage can be customised with your own shell functions - <strong>as long as no bashisms are used</strong>. Each emsandbox filesystem image can also use a different <tt>suite&nbsp;script</tt> so each machine:variant has full support over the contents of the root filesystem. <span class="anchor" id="line-595"></span><span class="anchor" id="line-596"></span></p><p class="line862">Note that none of the emsandbox / empbuilderlib support functions are available within <tt>second_stage_install&nbsp;()</tt> - only standard debootstrap functions exist (and those are removed once <tt>debootstrap&nbsp;--second-stage</tt> completes). <span class="anchor" id="line-597"></span><span class="anchor" id="line-598"></span></p><p class="line867">
</p><h3 id="approximate_time_and_SecureApt">approximate time and SecureApt</h3>
<span class="anchor" id="line-599"></span><span class="anchor" id="line-600"></span><p class="line862">The above snippet includes a time handler in <tt>second_stage_install&nbsp;()&nbsp;</tt> which is a bit of an oddity. It uses support in emsandbox to create an approximate time string within the filesystem image as a file called <tt>/datestring</tt>. The intention is to allow a sensible, approximate, time to be set on the device without requiring network access. Otherwise, getting the correct time would be the only stage in the installation that would require a network connection. <tt>ntp</tt> is available to any Emdebian device and includes <tt>ntpdate-debian</tt> so that once a working network connection becomes available, the current time can be set precisely. Without even an approximate time, various parts of the Debian setup can get confused - especially relating to GnuPG keys or signature verification (gpg doesn't like timestamps in 1970 when verifying signatures made 30 years 'into the future'). This support is needed for <a href="https://wiki.debian.org/SecureApt">SecureApt</a> configuration. <span class="anchor" id="line-601"></span><span class="anchor" id="line-602"></span></p><p class="line862">0x97BB3B58.txt is the Emdebian Archive Keyring as gpg armoured text, it is added to <tt>apt-key</tt> during the postinst configuration of the <tt>debian-archive-keyring</tt> package in Emdebian to provide <a href="https://wiki.debian.org/SecureApt">SecureApt</a> support. <span class="anchor" id="line-603"></span><span class="anchor" id="line-604"></span></p><p class="line867"><tt>/datestring</tt> uses a time format supported by the busybox implementation of <tt>date</tt>: <span class="anchor" id="line-605"></span><span class="anchor" id="line-606"></span><span class="anchor" id="line-607"></span></p><pre><span class="anchor" id="line-1-45"></span>        date +%m%d%H%M%Y</pre><span class="anchor" id="line-608"></span><span class="anchor" id="line-609"></span><p class="line867">
</p><h2 id="Installing_the_image">Installing the image</h2>
<span class="anchor" id="line-610"></span><span class="anchor" id="line-611"></span><p class="line862">Current methods involve using existing support on the device (in my case a balloon3). The intention is to be able to support any method of copying the filesystem image tarball onto the device, including using the Debian Installer. For this to work, all necessary setup needs to be retained within the packages themselves or the <tt>suite&nbsp;script</tt> via emsandbox machine:variant support. <span class="anchor" id="line-612"></span><span class="anchor" id="line-613"></span></p><p class="line862">D-I would then handle the filesystem image created by emsandbox and calls <tt>emsecondstage</tt> which is installed by emsandbox to merge the machine:variant support with <tt>debootstrap&nbsp;--second-stage</tt>. D-I would use the interactive form of cdebconf support. For this to work, Emdebian needs to rebuild the D-I udebs so that the D-I code itself is reduced in size. <span class="anchor" id="line-614"></span><span class="anchor" id="line-615"></span></p><p class="line867"></p><hr><p class="line874"> <span class="anchor" id="line-616"></span><a href="https://wiki.debian.org/CategoryEmdebian">CategoryEmdebian</a> <span class="anchor" id="line-617"></span><span class="anchor" id="bottom"></span></p></div><div id="pagebottom"></div>
</div>


<div id="footer">
<p id="pageinfo" class="info" lang="en" dir="ltr">EmDebian/CrossDebootstrap  (<a class="nbinfo" href="https://wiki.debian.org/EmDebian/CrossDebootstrap?action=info" rel="nofollow">last modified 2017-09-24 07:50:02</a>)</p>

<ul id="credits">
<li><a href="https://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="https://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li>Debian Wiki <a href="https://wiki.debian.org/Teams/DebianWiki">team</a>, <a href="https://bugs.debian.org/wiki.debian.org">bugs</a> and <a href="https://git.debian.org/?p=collab-maint/wiki.debian.org.git;a=summary">config</a> available.</li><li>Hosting provided by <a href="https://www.man-da.de/">Metropolitan Area Network Darmstadt</a></li>
</ul>


</div>



</body></html>